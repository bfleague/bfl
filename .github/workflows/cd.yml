name: Deploy

env:
  REGISTRY: registry.haxbrasil.com
  NAME: bfl
  REC_CHANNEL_ID: 952383094130892810
  GUILD_ID: 952375559554490440
  ENABLE_LOG: true
  DISCORD_INVITE: https://discord.gg/6Fq5hhxU8e

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - id: gh_repo
        run: echo "::set-output name=lowerCaseValue::${UPPERCASE_VAR,,}"
        env:
          UPPERCASE_VAR: ${{ github.repository }}

      - name: Log in to Container Registry
        run: |
          sudo docker login ${{ env.REGISTRY }} -u ${{ secrets.REGISTRY_USERNAME }} -p ${{ secrets.REGISTRY_PASSWORD }}

      - name: Create env file
        run: |
          echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" > .env
          echo "REC_CHANNEL_ID=${{ env.REC_CHANNEL_ID }}" > .env
          echo "GUILD_ID=${{ env.GUILD_ID }}" > .env
          echo "ENABLE_LOG=${{ env.ENABLE_LOG }}" > .env
          echo "UNSAFE_CONNECTION_LOG=${{ secrets.UNSAFE_CONNECTION_LOG }}" > .env
          echo "SAFE_CONNECTION_LOG=${{ secrets.SAFE_CONNECTION_LOG }}" > .env
          echo "CHAT_LOG=${{ secrets.CHAT_LOG }}" > .env
          echo "DISCORD_INVITE=${{ env.DISCORD_INVITE }}" > .env

      - name: Build Docker image
        run: |
          sudo docker build -t ${{ env.REGISTRY }}/${{ steps.gh_repo.outputs.lowerCaseValue }}/${{ env.NAME }}:latest .

      - name: Push Docker image
        run: |
          sudo docker push ${{ env.REGISTRY }}/${{ steps.gh_repo.outputs.lowerCaseValue }}/${{ env.NAME }}:latest

      - name: Deploy using SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: 22
          script: |
            docker login ${{ env.REGISTRY }} -u ${{ secrets.REGISTRY_USERNAME }} -p ${{ secrets.REGISTRY_PASSWORD }}
            sudo docker pull ${{ env.REGISTRY }}/${{ steps.gh_repo.outputs.lowerCaseValue }}/${{ env.NAME }}:latest
            sudo docker image prune --force
